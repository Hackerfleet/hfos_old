<%inherit file="base.html" />
    <%block name="css">
    <link rel="stylesheet" href="/assets/css/leaflet.css" />
    <link rel="stylesheet" href="/assets/css/L.Control.Pan.css" />
    <!--[if lt IE 9]>
    <link rel="stylesheet" href="/assets/css/L.Control.Pan.ie.css"/>
    <![endif]-->
    <link rel="stylesheet" href="/assets/css/L.Control.Zoomslider.css"/>


    <style type="text/css">
        body {
            padding: 0px;
            margin: 0px;
        }
        html, body, #map {
            padding-top: 23px;
            height: 100%;
        }
        body {
            padding-top: 50px;
            padding-bottom: 50px;
        }
        .leaflet-container .leaflet-control-mouseposition {
            background-color: rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 5px #bbb;
            padding: 0 5px;
            margin:0;
            color: #333;
            font: 11px/1.5 "Helvetica Neue", Arial, Helvetica, sans-serif;
        }
    </style>

    </%block>
    <%block name="title">Navigation...</%block>
    <%block name="header">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src="/assets/js/leaflet.js"></script>
    <script src="/assets/js/Leaflet.transformmarker.js"></script>
    <script src="/assets/js/L.Terminator.js"></script>
    <script src="/assets/js/L.Graticule.js"></script>
    <script src="/assets/js/L.Control.MousePosition.js"></script>
    <script src="/assets/js/L.Control.Pan.js"></script>
    <script src="/assets/js/L.Control.Zoomslider.js"></script>

    <script lang="javascript">
    </script>

    </%block>


    <div id="map">

    </div>
    <div id="button-wrapper" class="navbar navbar-default navbar-fixed-bottom">
        <input type="checkbox" id="cb_follow" checked><label>Follow</label>
    </div>



<script lang="javascript">
    /* // Howto include a geojson layer:
    $(document).ready(function() {
        $.ajax({
            type: "POST",
            url: "navigation/map",
            contentType: 'application/json',
            dataType: 'json',
            success: function (response) {

                geojsonLayer = L.geoJson(response, {}).addTo(map);
            }
        });

    } );
    */


        L.RotatedMarker = L.Marker.extend({
          options: { angle: 0 },
          _setPos: function(pos) {
            L.Marker.prototype._setPos.call(this, pos);
            if (L.DomUtil.TRANSFORM) {
              // use the CSS transform rule if available
              this._icon.style[L.DomUtil.TRANSFORM] += ' rotate(' + this.options.angle + 'deg)';
            } else if (L.Browser.ie) {
              // fallback for IE6, IE7, IE8
              var rad = this.options.angle * L.LatLng.DEG_TO_RAD,
              costheta = Math.cos(rad),
              sintheta = Math.sin(rad);
              this._icon.style.filter += ' progid:DXImageTransform.Microsoft.Matrix(sizingMethod=\'auto expand\', M11=' +
                costheta + ', M12=' + (-sintheta) + ', M21=' + sintheta + ', M22=' + costheta + ')';
            }
          }
        });
        L.rotatedMarker = function(pos, options) {
            return new L.RotatedMarker(pos, options);
        };



        var VesselIcon = L.icon({
            iconUrl: '/assets/icons/vessel.png',
            //shadowUrl: 'leaf-shadow.png',

            iconSize:     [25, 25], // size of the icon
            //shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [12, 12], // point of the icon which will correspond to marker's location
            //shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [-3, -76] // point from which the popup should open relative to the iconAnchor
        });

        var map = L.map('map', {
            center: [52.513, 13.41998],
            zoom: 16,
            maxZoom: 17,
            minZoom: 3,
            zoomControl: false,
            zoomsliderControl: true,
        });

        Terminator = L.terminator(); //.addTo(map);

        GraticuleOne = L.graticule({ style: { color: '#55A', weight: 1, dashArray: '.'}, interval: 1 }).addTo(map);

        MousePosition = L.control.mousePosition().addTo(map);

        L.control.pan().addTo(map);

        var openStreetMapUrl = 'http://{s}.tile.osm.org/{z}/{x}/{y}.png';
        var seamarksUrl = 'http://tiles.openseamap.org/seamark/{z}/{x}/{y}.png';
        var sportsUrl = 'http://tiles.openseamap.org/sport/{z}/{x}/{y}.png';

        var openStreetMapAttribution = '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors';
        var OpenSeaMapAttribution = 'Map data &copy; 2012 OpenSeaMap contributors';

        var osmlayer       = L.tileLayer(openStreetMapUrl, {attribution: openStreetMapAttribution}).addTo(map);
            seamarkslayer  = L.tileLayer(seamarksUrl, {maxZoom: 16, attribution: OpenSeaMapAttribution}).addTo(map);
            sportslayer    = L.tileLayer(sportsUrl, {minZoom: 8, maxZoom: 18, attribution: OpenSeaMapAttribution});
            cloudmadelayer = L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
            });

        var baseMaps = {
            "Default": osmlayer,
            "Cloudmade": cloudmadelayer,
        }

        var overlayMaps = {
            "Seamarks": seamarkslayer,
            "Sports": sportslayer,
            "Terminator": Terminator,
            "Grid 1°": GraticuleOne,
        }

        L.control.layers(baseMaps, overlayMaps).addTo(map);

        function onMapClick(e) {
            popup
                .setLatLng(e.latlng)
                .setContent("You clicked the map at " + e.latlng.toString())
                .openOn(map);
        }

        map.on('click', onMapClick);

        var Follow = false;
        var Coords = [0,0];
        var Course = 0;

        VesselMarker = L.rotatedMarker(Coords, {icon: VesselIcon}).addTo(map);

        $(document).ready(function(){
            UpdateMapMarker();
        });

        function UpdateMapMarker(){
            console.log("Getting current Vessel position");
            $.ajax({
                type: "POST",
                url: "logbook/latest",
                contentType: 'application/json',
                dataType: 'json',
                success: function (response) {
                    Coords = response.coords;
                    Course = response.course;
                    console.log("Coords: " + Coords + " Course:" + Course);

                }
            });
            VesselMarker.setLatLng(Coords);
            VesselMarker.options.angle = Course;
            VesselMarker.update();

            if($("#cb_follow").is(':checked')){
                map.panTo(Coords);
            }

            setTimeout(function(){
                UpdateMapMarker();}, 3000);
        }


</script>

